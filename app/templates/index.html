<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Advanced Market Dashboard</title>

<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#0f172a; color:#e2e8f0; }
.card { border-radius:14px; padding:20px; border:1px solid #1f2937; transition:0.3s; position: relative; overflow: hidden; }
.section-title { font-size:18px; font-weight:600; margin-bottom:10px; }
.tab { cursor:pointer; padding:12px 20px; }
.tab-active { border-bottom:2px solid #6366f1; }

.bullish { background:rgba(16,185,129,0.08); border-color:#10b981; }
.bearish { background:rgba(244,63,94,0.08); border-color:#f43f5e; }
.neutral { background:rgba(99,102,241,0.08); border-color:#6366f1; }
.warning { background:rgba(245,158,11,0.08); border-color:#f59e0b; }

.glow-green {
  animation: glow 1.5s ease forwards;
}

@keyframes glow {
  0% { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
  50% { background-color: #22c55e; box-shadow: 0 0 15px #22c55e; }
  100% { background-color: #6366f1; box-shadow: none; }
}

.toggle-btn {
  position: absolute;
  top: 12px;
  right: 12px;
  width: 32px;
  height: 32px;
  border-radius: 6px;
  background: rgba(99, 102, 241, 0.2);
  border: 1px solid #6366f1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  z-index: 10;
}

.toggle-btn:hover {
  background: rgba(99, 102, 241, 0.3);
  transform: scale(1.05);
}

.card-hidden {
  opacity: 0.4;
  height: 60px;
  overflow: hidden;
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;


async function getBrokerLoginUrl(broker) {
  const res = await fetch(`/api/${broker}/login-url`);
  return res.json();
}

async function getBrokerStatus() {
  const res = await fetch("/api/brokers/status");
  return res.json();
}

async function getBrokerLivePnl() {
  const res = await fetch("/api/brokers/pnl");
  return res.json();
}

async function switchActiveBroker(broker) {
  const res = await fetch("/api/brokers/switch", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ broker }),
  });
  return res.json();
}

async function placeBrokerOrder(order) {
  const res = await fetch("/api/brokers/place-order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(order),
  });
  return res.json();
}

async function deployWithEngine(order) {
  const res = await fetch("/api/brokers/deploy", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(order),
  });
  return res.json();
}

async function processDeploymentEngine(planId) {
  const res = await fetch("/api/brokers/deploy/process", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(planId ? { plan_id: planId } : {}),
  });
  return res.json();
}

async function getDeploymentStatus(planId) {
  const res = await fetch(`/api/brokers/deploy/${planId}`);
  return res.json();
}

async function configureBrokerCredentials(payload) {
  const res = await fetch("/api/brokers/configure", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  return res.json();
}

async function disconnectBroker(broker) {
  const res = await fetch("/api/brokers/disconnect", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ broker }),
  });
  return res.json();
}

async function getBrokerExpiries(symbol = "NIFTY") {
  const res = await fetch(`/api/brokers/expiries?symbol=${symbol}`);
  return res.json();
}

const endpoints = {
  pcr: "/api/pcr",
  vix: "/api/vix",
  indices: "/api/indices",
  oi: "/api/oi-change",
  mmi: "/api/mmi",
  rsi: "/api/rsi",
  bias: "/api/marketbias",
  niftyavgs: "/api/niftyavgs",
  macd: "/api/macd"
};

function getCardClass(text) {
  if (!text) return "card neutral";
  const t = text.toLowerCase();
  if (t.includes("bull")) return "card bullish";
  if (t.includes("bear")) return "card bearish";
  if (t.includes("greed")) return "card warning";
  if (t.includes("fear")) return "card bearish";
  if (t.includes("complacent")) return "card bullish";
  if (t.includes("stable")) return "card bullish";
  if (t.includes("nervous")) return "card bearish";
  if (t.includes("strong buy")) return "card bullish";
  if (t.includes("strong sell")) return "card bearish";
  if (t.includes("buy")) return "card bullish";
  return "card neutral";
}

function getMacdCardClass(macd) {
  if (!macd) return "card neutral";

  const macdSignal = macd?.MACD_signal;
  const momentum = macd?.Momentum;
  const stochasticSignal = macd?.Stochastic_signal;

  if (macdSignal === "Bullish crossover" && momentum === "Positive") return "card bullish";
  if (macdSignal === "Bearish crossover" && momentum === "Negative") return "card bearish";
  if (stochasticSignal === "Overbought") return "card bearish";
  if (stochasticSignal === "Oversold") return "card bullish";

  return "card neutral";
}

function useAPI() {
  const [data, setData] = useState({});

  function isMarketOpen() {
    const now = new Date();
    const istTime = new Date(
      now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
    );
    const hours = istTime.getHours();
    const minutes = istTime.getMinutes();
    const totalMinutes = hours * 60 + minutes;
    const marketOpen = 9 * 60;
    const marketClose = 15 * 60 + 30;
    return totalMinutes >= marketOpen && totalMinutes <= marketClose;
  }

  async function fetchAll() {
    const results = {};
    for (const key in endpoints) {
      try {
        const res = await fetch(endpoints[key]);
        results[key] = await res.json();
      } catch {
        results[key] = null;
      }
    }
    setData(results);
  }

  useEffect(() => {
    fetchAll();
    if (!isMarketOpen()) return;
    const interval = setInterval(fetchAll, 3000);
    return () => clearInterval(interval);
  }, []);

  return { data };
}

function KeyValue({label, value}) {
  return (
    <div className="flex justify-between py-1 text-sm gap-3 items-start">
      <span className="text-gray-400 flex-shrink-0 min-w-0">{label}</span>
      <span className="text-right break-words overflow-wrap-anywhere max-w-[60%]">{value ?? "-"}</span>
    </div>
  );
}

function ToggleButton({ isHidden, onToggle }) {
  return (
    <button
      onClick={onToggle}
      className="toggle-btn"
      title={isHidden ? "Show card" : "Hide card"}
    >
      {isHidden ? (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
      ) : (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
          <line x1="1" y1="1" x2="23" y2="23"/>
        </svg>
      )}
    </button>
  );
}

function formatIndexValue(value, decimals = 2) {
  const num = Number(value);
  if (!Number.isFinite(num)) return value ?? "-";
  return num.toFixed(decimals);
}

function formatPercent(value, decimals = 2) {
  const num = Number(value);
  if (!Number.isFinite(num)) return "-";
  const sign = num > 0 ? "+" : "";
  return `${sign}${num.toFixed(decimals)}%`;
}


function LiveIndicesCard({ indices, connectedBrokerLabel = null, connectedPlatformLabels = [] }) {
  return (
    <div className="card neutral h-full">
      <div className="section-title">Live Indices</div>
      <div className="grid grid-cols-3 gap-3 md:gap-4 text-center">
        <div className="min-w-0">
          <div className="text-[clamp(1.25rem,1.8vw,2rem)] font-bold leading-tight text-cyan-400">{formatIndexValue(indices?.NIFTY50)}</div>
          <div className="text-gray-400">NIFTY50</div>
        </div>
        <div className="min-w-0">
          <div className="text-[clamp(1.25rem,1.8vw,2rem)] font-bold leading-tight text-emerald-400">{formatIndexValue(indices?.BANKNIFTY)}</div>
          <div className="text-gray-400">BANKNIFTY</div>
        </div>
        <div className="min-w-0">
          <div className="text-[clamp(1.25rem,1.8vw,2rem)] font-bold leading-tight text-rose-400">{formatIndexValue(indices?.SENSEX, 2)}</div>
          <div className="text-gray-400">SENSEX</div>
        </div>
      </div>
      <div className="mt-4 text-gray-500 text-sm">{indices?.timestamp}</div>
      <div className="mt-1 text-xs text-gray-400">
        NSE Capital Market: <span className={indices?.market?.isOpen ? "text-green-400" : "text-amber-400"}>{indices?.market?.status ?? "Unknown"}</span>
        {connectedBrokerLabel && (
          <>
            <span className="mx-1 text-gray-500">•</span>
            <span>Broker: <span className="text-cyan-300">{connectedBrokerLabel}</span></span>
          </>
        )}
      </div>
      {connectedPlatformLabels.length > 0 && (
        <div className="mt-3 border-t border-gray-800 pt-3">
          <div className="text-xs text-gray-400 mb-1">Trading Platforms</div>
          <div className="flex flex-wrap gap-2">
            {connectedPlatformLabels.map((label) => (
              <span key={label} className="text-xs px-2 py-1 rounded-full border border-green-500/60 bg-green-500/10 text-green-300">
                {label} Connected
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

function formatCurrency(value) {
  const num = Number(value);
  if (!Number.isFinite(num)) return "-";
  return `₹${num.toLocaleString("en-IN", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
}

function PlatformStatusCard({ brokerStatus }) {
  const items = [
    { key: "zerodha", label: "Zerodha" },
    { key: "fyers", label: "Fyers" },
    { key: "stoxkart", label: "Stoxkart" },
  ];
  const connectedItems = items.filter((item) => !!brokerStatus?.brokers?.[item.key]?.connected);

  return (
    <div className="card neutral h-full">
      <div className="section-title mb-2 text-base">Trading Platform Status</div>
      <div className="space-y-1.5">
        {connectedItems.length === 0 ? (
          <div className="text-xs text-gray-400">No connected platforms</div>
        ) : connectedItems.map((item) => (
          <div key={item.key} className="flex items-center justify-between text-xs">
            <span>{item.label}</span>
            <span className="font-semibold text-green-400">Connected</span>
          </div>
        ))}
      </div>
    </div>
  );
}

function LivePnlCard({ livePnl, sourceLabel }) {
  const totalPnl = Number(livePnl?.total_pnl || 0);
  const pnlClass = totalPnl >= 0 ? "text-green-400" : "text-rose-400";

  return (
    <div className="card neutral h-full">
      <div className="section-title mb-2 text-base">Live P&amp;L</div>
      <div className={`text-2xl font-bold ${pnlClass}`}>{formatCurrency(totalPnl)}</div>
      <div className="mt-2 space-y-1">
        <div className="flex items-center justify-between text-xs">
          <span className="text-gray-400">Day MTM</span>
          <span>{formatCurrency(livePnl?.day_m2m)}</span>
        </div>
        <div className="flex items-center justify-between text-xs">
          <span className="text-gray-400">Open Positions</span>
          <span>{livePnl?.open_positions ?? 0}</span>
        </div>
      </div>
      <div className="mt-3 text-[11px] text-gray-500">{livePnl?.success ? `Broker: ${sourceLabel || "Connected Broker"}` : (livePnl?.error || "Unavailable")}</div>
    </div>
  );
}

function LiveHeaderRow({ indices, brokerStatus, livePnl, showLivePnl = false, showPlatformStatus = true, mergePlatformStatusIntoIndices = false }) {
  const connectedBrokers = Object.entries(brokerStatus?.brokers || {})
    .filter(([, state]) => !!state?.connected)
    .map(([name]) => name);

  const sourceBroker = livePnl?.source_broker
    || connectedBrokers[0]
    || brokerStatus?.active_broker
    || null;

  const sourceLabel = sourceBroker
    ? sourceBroker.charAt(0).toUpperCase() + sourceBroker.slice(1)
    : null;

  const connectedPlatformLabels = connectedBrokers.map((name) => name.charAt(0).toUpperCase() + name.slice(1));
  const shouldShowPlatformCard = showPlatformStatus && !mergePlatformStatusIntoIndices;

  const gridClass = showLivePnl
    ? (shouldShowPlatformCard ? "md:grid-cols-3" : "md:grid-cols-[2fr_1fr]")
    : "md:grid-cols-[2fr_1fr]";

  return (
    <div className={`grid gap-6 items-stretch ${gridClass}`}>
      <LiveIndicesCard indices={indices} connectedPlatformLabels={mergePlatformStatusIntoIndices ? connectedPlatformLabels : []} />
      {shouldShowPlatformCard && <PlatformStatusCard brokerStatus={brokerStatus} />}
      {showLivePnl && <LivePnlCard livePnl={livePnl} sourceLabel={sourceLabel} />}
    </div>
  );
}

/* ---------------- MOVING AVERAGES CARDS ---------------- */

function NiftyPriceCard({niftyavgs, isHidden, onToggle}) {
  if (!niftyavgs) return null;

  const { price_data, trend_analysis } = niftyavgs;

  const hasBullishTrend = trend_analysis?.some(t => t.includes("bullish"));
  const hasBearishTrend = trend_analysis?.some(t => t.includes("Bearish"));
  
  let trendClass = "card neutral";
  if (hasBullishTrend && !hasBearishTrend) trendClass = "card bullish";
  else if (hasBearishTrend) trendClass = "card bearish";

  return (
    <div className={`${trendClass} ${isHidden ? 'card-hidden' : ''}`}>
      <ToggleButton isHidden={isHidden} onToggle={onToggle} />
      <div className="section-title">NIFTY Trend Analysis</div>
      {!isHidden && trend_analysis && trend_analysis.length > 0 && (
        <div>
          <div className="text-sm font-semibold text-gray-300 mb-2">Trend Signals</div>
          {trend_analysis.map((trend, idx) => (
            <div key={idx} className="text-sm text-gray-300 py-1">
              • {trend}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

function SimpleMovingAveragesCard({niftyavgs, isHidden, onToggle}) {
  if (!niftyavgs) return null;

  const { moving_averages } = niftyavgs;

  return (
    <div className={`card neutral ${isHidden ? 'card-hidden' : ''}`}>
      <ToggleButton isHidden={isHidden} onToggle={onToggle} />
      <div className="section-title">Simple Moving Averages</div>
      {!isHidden && moving_averages && (
        <div className="space-y-1">
          <KeyValue 
            label="MA 10" 
            value={`${moving_averages.MA_10?.value} (${moving_averages.MA_10?.position} ${moving_averages.MA_10?.difference_percent}%)`}
          />
          <KeyValue 
            label="MA 20" 
            value={`${moving_averages.MA_20?.value} (${moving_averages.MA_20?.position} ${moving_averages.MA_20?.difference_percent}%)`}
          />
          <KeyValue 
            label="MA 50" 
            value={`${moving_averages.MA_50?.value} (${moving_averages.MA_50?.position} ${moving_averages.MA_50?.difference_percent}%)`}
          />
          <KeyValue 
            label="MA 100" 
            value={`${moving_averages.MA_100?.value} (${moving_averages.MA_100?.position} ${moving_averages.MA_100?.difference_percent}%)`}
          />
        </div>
      )}
    </div>
  );
}

function ExponentialMovingAveragesCard({niftyavgs, isHidden, onToggle}) {
  if (!niftyavgs) return null;

  const { exponential_moving_averages } = niftyavgs;

  return (
    <div className={`card neutral ${isHidden ? 'card-hidden' : ''}`}>
      <ToggleButton isHidden={isHidden} onToggle={onToggle} />
      <div className="section-title">Exponential Moving Averages</div>
      {!isHidden && exponential_moving_averages && (
        <div className="space-y-1">
          <KeyValue 
            label="EMA 10" 
            value={`${exponential_moving_averages.EMA_10?.value} (${exponential_moving_averages.EMA_10?.position} ${exponential_moving_averages.EMA_10?.difference_percent}%)`}
          />
          <KeyValue 
            label="EMA 20" 
            value={`${exponential_moving_averages.EMA_20?.value} (${exponential_moving_averages.EMA_20?.position} ${exponential_moving_averages.EMA_20?.difference_percent}%)`}
          />
          <KeyValue 
            label="EMA 50" 
            value={`${exponential_moving_averages.EMA_50?.value} (${exponential_moving_averages.EMA_50?.position} ${exponential_moving_averages.EMA_50?.difference_percent}%)`}
          />
          <KeyValue 
            label="EMA 100" 
            value={`${exponential_moving_averages.EMA_100?.value} (${exponential_moving_averages.EMA_100?.position} ${exponential_moving_averages.EMA_100?.difference_percent}%)`}
          />
        </div>
      )}
    </div>
  );
}

/* ---------------- DASHBOARD ---------------- */

function DashboardTab({data, brokerStatus, livePnl}) {
  const { pcr, vix, oi, rsi, indices, niftyavgs, macd } = data;
  const hiddenCardsStorageKey = "dashboardHiddenCards";
  const defaultHiddenCards = {
    pcr: false,
    vix: false,
    oi: false,
    rsi: false,
    niftyPrice: false,
    sma: false,
    ema: false,
    macd: false
  };
  
  const [hiddenCards, setHiddenCards] = useState(() => {
    try {
      const savedHiddenCards = localStorage.getItem(hiddenCardsStorageKey);
      if (!savedHiddenCards) return defaultHiddenCards;

      const parsedHiddenCards = JSON.parse(savedHiddenCards);
      return { ...defaultHiddenCards, ...parsedHiddenCards };
    } catch {
      return defaultHiddenCards;
    }
  });

  useEffect(() => {
    localStorage.setItem(hiddenCardsStorageKey, JSON.stringify(hiddenCards));
  }, [hiddenCards]);

  const toggleCard = (cardName) => {
    setHiddenCards(prev => ({
      ...prev,
      [cardName]: !prev[cardName]
    }));
  };

  // Separate visible and hidden cards
  const cards = [
    { id: 'pcr', component: (
      <div className={`${getCardClass(pcr?.zone)} ${hiddenCards.pcr ? 'card-hidden' : ''}`}>
        <ToggleButton isHidden={hiddenCards.pcr} onToggle={() => toggleCard('pcr')} />
        <div className="section-title">Overall PCR</div>
        {!hiddenCards.pcr && (
          <>
            <KeyValue label="PCR" value={pcr?.pcr}/>
            <KeyValue label="Sentiment" value={pcr?.sentiment}/>
            <KeyValue label="Zone" value={pcr?.zone}/>
            <div className="mt-3 text-sm break-words">{pcr?.action}</div>
          </>
        )}
      </div>
    )},
    { id: 'vix', component: (
      <div className={`${getCardClass(vix?.sentiment)} ${hiddenCards.vix ? 'card-hidden' : ''}`}>
        <ToggleButton isHidden={hiddenCards.vix} onToggle={() => toggleCard('vix')} />
        <div className="section-title">VIX</div>
        {!hiddenCards.vix && (
          <>
            <KeyValue label="VIX" value={vix?.vix}/>
            <KeyValue label="Sentiment" value={vix?.sentiment}/>
            <div className="mt-3 text-sm break-words">{vix?.action}</div>
          </>
        )}
      </div>
    )},
    { id: 'oi', component: (
      <div className={`${getCardClass(oi?.zone)} ${hiddenCards.oi ? 'card-hidden' : ''}`}>
        <ToggleButton isHidden={hiddenCards.oi} onToggle={() => toggleCard('oi')} />
        <div className="section-title">Intraday OI Change PCR</div>
        {!hiddenCards.oi && (
          <>
            <KeyValue label="Value" value={oi?.oi_change_pcr}/>
            <KeyValue label="Sentiment" value={oi?.sentiment}/>
            <KeyValue label="Zone" value={oi?.zone}/>
            <div className="mt-3 text-sm break-words">{oi?.action}</div>
          </>
        )}
      </div>
    )},
    { id: 'rsi', component: (
      <div className={`${getCardClass(rsi?.sentiment)} ${hiddenCards.rsi ? 'card-hidden' : ''}`}>
        <ToggleButton isHidden={hiddenCards.rsi} onToggle={() => toggleCard('rsi')} />
        <div className="section-title">RSI</div>
        {!hiddenCards.rsi && (
          <>
            <KeyValue label="RSI 15min" value={rsi?.rsi15min}/>
            <KeyValue label="RSI 1hr" value={rsi?.rsi1hr}/>
            <KeyValue label="Sentiment" value={rsi?.sentiment}/>
          </>
        )}
      </div>
    )},
    { id: 'niftyPrice', component: <NiftyPriceCard niftyavgs={niftyavgs} isHidden={hiddenCards.niftyPrice} onToggle={() => toggleCard('niftyPrice')} /> },
    { id: 'sma', component: <SimpleMovingAveragesCard niftyavgs={niftyavgs} isHidden={hiddenCards.sma} onToggle={() => toggleCard('sma')} /> },
    { id: 'ema', component: <ExponentialMovingAveragesCard niftyavgs={niftyavgs} isHidden={hiddenCards.ema} onToggle={() => toggleCard('ema')} /> },
    { id: 'macd', component: (
      <div className={`${getMacdCardClass(macd)} ${hiddenCards.macd ? 'card-hidden' : ''}`}>
        <ToggleButton isHidden={hiddenCards.macd} onToggle={() => toggleCard('macd')} />
        <div className="section-title">MACD Indicator</div>
        {!hiddenCards.macd && (
          <>
            <KeyValue label="MACD Signal" value={macd?.MACD_signal}/>
            <KeyValue label="Stochastic" value={macd?.Stochastic_signal}/>
            <KeyValue label="Momentum" value={macd?.Momentum}/>
            <div className="mt-3 text-sm break-words">{macd?.Option_Strategy}</div>
          </>
        )}
      </div>
    )},
  ];

  const visibleCards = cards.filter(card => !hiddenCards[card.id]);
  const collapsedCards = cards.filter(card => hiddenCards[card.id]);

  return (
    <div className="space-y-8">
      <LiveHeaderRow indices={indices} brokerStatus={brokerStatus} livePnl={livePnl} showLivePnl={false} />

      <div className="grid md:grid-cols-3 gap-6">
        {visibleCards.map(card => (
          <div key={card.id}>{card.component}</div>
        ))}
        {collapsedCards.map(card => (
          <div key={card.id}>{card.component}</div>
        ))}
      </div>
    </div>
  );
}

/* ---------------- STRATEGY ACCORDION ---------------- */

function StrategyAccordion({ name, data, isOpen, onToggle, buildOrders, selectedBrokers, failoverEnabled, expiryDate, onTradeActivity }) {
  const [deployed, setDeployed] = useState(false);
  const [quantity, setQuantity] = useState(1);
  const [deployMessage, setDeployMessage] = useState("");
  const [deploymentStats, setDeploymentStats] = useState({ bought: 0, pending: 0 });
  const [activePlanIds, setActivePlanIds] = useState([]);

  if (!data) return null;

  useEffect(() => {
    if (activePlanIds.length === 0) return;

    const interval = setInterval(async () => {
      try {
        let bought = 0;
        let pending = 0;
        for (const planId of activePlanIds) {
          await processDeploymentEngine(planId);
          const status = await getDeploymentStatus(planId);
          const plan = status?.plan || {};
          bought += Number(plan.bought_lots || 0);
          pending += Number(plan.pending_lots || 0);
        }
        setDeploymentStats({ bought, pending });
      } catch {
        // keep UI quiet during polling failures
      }
    }, 15000);

    return () => clearInterval(interval);
  }, [activePlanIds]);

  const handleDeploy = async (e) => {
    e.stopPropagation();

    try {
      const orders = buildOrders(quantity);
      let bought = 0;
      let pending = 0;
      const createdPlanIds = [];
      for (const order of orders) {
        const result = await deployWithEngine({
          ...order,
          brokers: selectedBrokers,
          failover_enabled: failoverEnabled,
          metadata: { ...(order.metadata || {}), expiry_date: expiryDate },
        });
        if (!result.success) {
          throw new Error(result.error || "Deployment creation failed");
        }
        const plan = result?.plan || {};
        createdPlanIds.push(plan.plan_id);
        bought += Number(plan.bought_lots || 0);
        pending += Number(plan.pending_lots || 0);
      }
      setActivePlanIds(createdPlanIds.filter(Boolean));
      setDeploymentStats({ bought, pending });
      setDeployMessage("Deployment queued (engine will process in ticks)");
      onTradeActivity?.();
      setDeployed(true);
      setTimeout(() => setDeployed(false), 1500);
    } catch (err) {
      setDeployMessage(err.message);
    }
  };

  return (
    <div className="border border-gray-700 rounded-lg mt-3 overflow-hidden">
      <div
        onClick={() => onToggle(name)}
        className="cursor-pointer bg-gray-800 px-4 py-3 flex justify-between items-center hover:bg-gray-700"
      >
        <span className="font-medium">{name}</span>
        <span>{isOpen ? "▲" : "▼"}</span>
      </div>

      {isOpen && (
        <div className="bg-gray-900 px-4 py-3 space-y-2">
          {Object.entries(data).map(([k,v]) => (
            <KeyValue key={k} label={k} value={v}/>
          ))}

          <div className="flex items-center gap-4 mt-2">
            <select
              className="px-2 py-1 rounded bg-gray-800 border border-gray-600 text-white"
              value={quantity}
              onChange={(e) => setQuantity(Number(e.target.value))}
            >
              {[...Array(10)].map((_, i) => (
                <option key={i+1} value={i+1}>{i+1}</option>
              ))}
            </select>

            <button
              onClick={handleDeploy}
              className={`px-4 py-2 rounded-md text-white ${deployed ? "bg-green-500 glow-green" : "bg-indigo-600 hover:bg-indigo-500"}`}
            >
              Deploy
            </button>
            {deployMessage && <span className="text-green-400 font-medium">{deployMessage}</span>}
          </div>
          <div className="text-sm text-cyan-300">Bought lots: {deploymentStats.bought} | Pending lots: {deploymentStats.pending}</div>
        </div>
      )}
    </div>
  );
}

/* ---------------- ATM OPTIONS CARD ---------------- */

function ATMOptionsCard({ ce, pe, selectedBrokers, failoverEnabled, expiryDate, expiries, onExpiryChange, onTradeActivity }) {
  const [ceQty, setCeQty] = useState(1);
  const [peQty, setPeQty] = useState(1);
  const [ceMessage, setCeMessage] = useState("");
  const [peMessage, setPeMessage] = useState("");
  const [cePlanId, setCePlanId] = useState("");
  const [pePlanId, setPePlanId] = useState("");
  const [ceStats, setCeStats] = useState({ bought: 0, pending: 0 });
  const [peStats, setPeStats] = useState({ bought: 0, pending: 0 });

  useEffect(() => {
    if (!cePlanId) return;
    const interval = setInterval(async () => {
      try {
        await processDeploymentEngine(cePlanId);
        const status = await getDeploymentStatus(cePlanId);
        const plan = status?.plan || {};
        setCeStats({ bought: Number(plan.bought_lots || 0), pending: Number(plan.pending_lots || 0) });
      } catch {
        // ignore transient errors
      }
    }, 15000);
    return () => clearInterval(interval);
  }, [cePlanId]);

  useEffect(() => {
    if (!pePlanId) return;
    const interval = setInterval(async () => {
      try {
        await processDeploymentEngine(pePlanId);
        const status = await getDeploymentStatus(pePlanId);
        const plan = status?.plan || {};
        setPeStats({ bought: Number(plan.bought_lots || 0), pending: Number(plan.pending_lots || 0) });
      } catch {
        // ignore transient errors
      }
    }, 15000);
    return () => clearInterval(interval);
  }, [pePlanId]);

  const handleCeDeploy = async () => {
    try {
      const result = await deployWithEngine({
        index_name: "NIFTY",
        strike: ce,
        option_type: "CE",
        quantity: ceQty,
        transaction_type: "BUY",
        brokers: selectedBrokers,
        failover_enabled: failoverEnabled,
        metadata: { expiry_date: expiryDate },
      });
      const plan = result?.plan || {};
      setCePlanId(plan.plan_id || "");
      setCeStats({ bought: Number(plan.bought_lots || 0), pending: Number(plan.pending_lots || 0) });
      if (result.success) onTradeActivity?.();
      setCeMessage(result.success ? "Deployment queued (engine tick pending)" : (result.error || "Deployment failed"));
    } catch (err) {
      setCeMessage(err.message);
    }
  };

  const handlePeDeploy = async () => {
    try {
      const result = await deployWithEngine({
        index_name: "NIFTY",
        strike: pe,
        option_type: "PE",
        quantity: peQty,
        transaction_type: "BUY",
        brokers: selectedBrokers,
        failover_enabled: failoverEnabled,
        metadata: { expiry_date: expiryDate },
      });
      const plan = result?.plan || {};
      setPePlanId(plan.plan_id || "");
      setPeStats({ bought: Number(plan.bought_lots || 0), pending: Number(plan.pending_lots || 0) });
      if (result.success) onTradeActivity?.();
      setPeMessage(result.success ? "Deployment queued (engine tick pending)" : (result.error || "Deployment failed"));
    } catch (err) {
      setPeMessage(err.message);
    }
  };

  return (
    <div className="card neutral mt-4 p-4">
      <div className="section-title">ATM Options</div>

      <div className="flex items-center gap-3 text-sm mt-1">
        <span className="text-gray-300">Expiry:</span>
        <select className="px-2 py-1 rounded bg-gray-800 border border-gray-600 text-white min-w-[160px]" value={expiryDate} onChange={(e) => onExpiryChange?.(e.target.value)}>
          {(expiries || [expiryDate]).filter(Boolean).map((exp) => (
            <option key={exp} value={exp}>{exp}</option>
          ))}
        </select>
      </div>

      <div className="grid grid-cols-1 gap-6 mt-2">
        <div className="flex flex-col gap-2">
          <div className="flex items-center justify-between">
            <div className="flex flex-col">
              <div className="font-medium">CE Strike</div>
              <div className="text-sm text-gray-200">{ce ?? "-"}</div>
            </div>
            <div className="flex gap-2">
              <select className="px-2 py-1 rounded bg-gray-800 border border-gray-600 text-white" value={ceQty} onChange={(e) => setCeQty(Number(e.target.value))}>
                {[...Array(100)].map((_, i) => (<option key={i+1} value={i+1}>{i+1}</option>))}
              </select>
              <button onClick={handleCeDeploy} className="px-4 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-500">Deploy CE</button>
            </div>
          </div>
          {ceMessage && <div className="text-sm text-cyan-300">{ceMessage}</div>}
          <div className="text-xs text-cyan-200">Bought lots: {ceStats.bought} | Pending lots: {ceStats.pending}</div>
        </div>

        <div className="border-t border-gray-600 mx-4"></div>

        <div className="flex flex-col gap-2">
          <div className="flex items-center justify-between">
            <div className="flex flex-col">
              <div className="font-medium">PE Strike</div>
              <div className="text-sm text-gray-200">{pe ?? "-"}</div>
            </div>
            <div className="flex gap-2">
              <select className="px-2 py-1 rounded bg-gray-800 border border-gray-600 text-white" value={peQty} onChange={(e) => setPeQty(Number(e.target.value))}>
                {[...Array(100)].map((_, i) => (<option key={i+1} value={i+1}>{i+1}</option>))}
              </select>
              <button onClick={handlePeDeploy} className="px-4 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-500">Deploy PE</button>
            </div>
          </div>
          {peMessage && <div className="text-sm text-cyan-300">{peMessage}</div>}
          <div className="text-xs text-cyan-200">Bought lots: {peStats.bought} | Pending lots: {peStats.pending}</div>
        </div>
      </div>
    </div>
  );
}

/* ---------------- OPTIONS ENGINE TAB ---------------- */

function OptionsEngineTab({data, selectedBrokers, brokerStatus, failoverEnabled, livePnl, onTradeActivity}) {
  const { bias, indices } = data;
  const [openStrategy, setOpenStrategy] = useState(null);
  const [expiries, setExpiries] = useState([]);
  const [selectedExpiry, setSelectedExpiry] = useState("");

  if (!bias) return null;

  const handleToggle = (name) => setOpenStrategy(openStrategy === name ? null : name);

  useEffect(() => {
    const fetchExpiries = async () => {
      try {
        const response = await getBrokerExpiries("NIFTY");
        const options = response?.expiries || [];
        setExpiries(options);
        if (options.length > 0) setSelectedExpiry((prev) => prev || options[0]);
      } catch {
        setExpiries([]);
      }
    };

    fetchExpiries();
  }, []);

  const strategyOrderBuilders = {
    "Iron Condor": (quantity) => [
      { index_name: "NIFTY", strike: bias?.strikes?.iron_condor?.sell_ce, option_type: "CE", transaction_type: "SELL", quantity },
      { index_name: "NIFTY", strike: bias?.strikes?.iron_condor?.buy_ce, option_type: "CE", transaction_type: "BUY", quantity },
      { index_name: "NIFTY", strike: bias?.strikes?.iron_condor?.sell_pe, option_type: "PE", transaction_type: "SELL", quantity },
      { index_name: "NIFTY", strike: bias?.strikes?.iron_condor?.buy_pe, option_type: "PE", transaction_type: "BUY", quantity },
    ].filter((o) => o.strike),
    "Calendar": (quantity) => [
      { index_name: "NIFTY", strike: bias?.strikes?.calendar?.ce_atm, option_type: "CE", transaction_type: "BUY", quantity },
      { index_name: "NIFTY", strike: bias?.strikes?.calendar?.pe_atm, option_type: "PE", transaction_type: "BUY", quantity },
    ].filter((o) => o.strike),
    "Call Spread": (quantity) => [
      { index_name: "NIFTY", strike: bias?.strikes?.spread_ce?.buy, option_type: "CE", transaction_type: "BUY", quantity },
      { index_name: "NIFTY", strike: bias?.strikes?.spread_ce?.sell, option_type: "CE", transaction_type: "SELL", quantity },
    ].filter((o) => o.strike),
    "Put Spread": (quantity) => [
      { index_name: "NIFTY", strike: bias?.strikes?.spread_pe?.buy, option_type: "PE", transaction_type: "BUY", quantity },
      { index_name: "NIFTY", strike: bias?.strikes?.spread_pe?.sell, option_type: "PE", transaction_type: "SELL", quantity },
    ].filter((o) => o.strike),
    "Butterfly": () => [],
  };

  return (
    <div className="space-y-8">
      <LiveHeaderRow indices={indices} brokerStatus={brokerStatus} livePnl={livePnl} showLivePnl showPlatformStatus={false} mergePlatformStatusIntoIndices />

      <div className={getCardClass(bias?.bias)}>
        <div className="section-title">Options Strategy Engine</div>
        <KeyValue label="Bias" value={bias?.bias}/>
        <KeyValue label="Score" value={bias?.score}/>
        <KeyValue label="VIX" value={bias?.vix}/>
        <div className="mt-4 border-t border-gray-700 pt-3">
          <div className="text-sm font-medium break-words">
            Execution Guidance: {bias?.primary_action || "Awaiting Setup"}
          </div>
        </div>
      </div>

      <ATMOptionsCard ce={bias?.strikes?.ce_strike} pe={bias?.strikes?.pe_strike} selectedBrokers={selectedBrokers} failoverEnabled={failoverEnabled} expiryDate={selectedExpiry} expiries={expiries} onExpiryChange={setSelectedExpiry} onTradeActivity={onTradeActivity} />

      <div className="card neutral">
        <div className="section-title">Strategy List</div>
        <div className="mb-3 flex items-center gap-3 text-sm">
          <span className="text-gray-300">Expiry Date</span>
          <select
            className="px-2 py-1 rounded bg-gray-800 border border-gray-600 text-white min-w-[170px]"
            value={selectedExpiry}
            onChange={(e) => setSelectedExpiry(e.target.value)}
          >
            {expiries.length === 0 && <option value="">No expiry data</option>}
            {expiries.map((exp) => (<option key={exp} value={exp}>{exp}</option>))}
          </select>
        </div>

        <StrategyAccordion name="Butterfly" data={bias?.strikes?.butterfly} isOpen={openStrategy === "Butterfly"} onToggle={handleToggle} buildOrders={strategyOrderBuilders["Butterfly"]} selectedBrokers={selectedBrokers} failoverEnabled={failoverEnabled} expiryDate={selectedExpiry} onTradeActivity={onTradeActivity} />
        <StrategyAccordion name="Iron Condor" data={bias?.strikes?.iron_condor} isOpen={openStrategy === "Iron Condor"} onToggle={handleToggle} buildOrders={strategyOrderBuilders["Iron Condor"]} selectedBrokers={selectedBrokers} failoverEnabled={failoverEnabled} expiryDate={selectedExpiry} onTradeActivity={onTradeActivity} />
        <StrategyAccordion name="Calendar" data={bias?.strikes?.calendar} isOpen={openStrategy === "Calendar"} onToggle={handleToggle} buildOrders={strategyOrderBuilders["Calendar"]} selectedBrokers={selectedBrokers} failoverEnabled={failoverEnabled} expiryDate={selectedExpiry} onTradeActivity={onTradeActivity} />
        <StrategyAccordion name="Call Spread" data={bias?.strikes?.spread_ce} isOpen={openStrategy === "Call Spread"} onToggle={handleToggle} buildOrders={strategyOrderBuilders["Call Spread"]} selectedBrokers={selectedBrokers} failoverEnabled={failoverEnabled} expiryDate={selectedExpiry} onTradeActivity={onTradeActivity} />
        <StrategyAccordion name="Put Spread" data={bias?.strikes?.spread_pe} isOpen={openStrategy === "Put Spread"} onToggle={handleToggle} buildOrders={strategyOrderBuilders["Put Spread"]} selectedBrokers={selectedBrokers} failoverEnabled={failoverEnabled} expiryDate={selectedExpiry} onTradeActivity={onTradeActivity} />
      </div>
    </div>
  );
}

function BrokersTab({ selectedBrokers, setSelectedBrokers, brokerStatus, refreshBrokerStatus, onSkip }) {
  const [message, setMessage] = useState("");
  const [selectedBroker, setSelectedBroker] = useState("zerodha");
  const [credentials, setCredentials] = useState({
    zerodha: { api_key: "", api_secret: "", access_token: "" },
    fyers: { api_key: "", api_secret: "", redirect_uri: "", access_token: "" },
    stoxkart: {
      api_key: "",
      api_secret: "",
      redirect_uri: "",
      auth_base_url: "",
      token_url: "",
      api_base_url: "",
      access_token: "",
    },
  });

  const toggleBroker = (broker) => {
    setSelectedBrokers((prev) => prev.includes(broker) ? prev.filter((b) => b !== broker) : [...prev, broker]);
  };

  const onFieldChange = (broker, field, value) => {
    setCredentials((prev) => ({
      ...prev,
      [broker]: {
        ...prev[broker],
        [field]: value,
      },
    }));
  };

  const configureBroker = async (broker) => {
    const payload = { broker, ...credentials[broker] };
    const res = await configureBrokerCredentials(payload);
    if (res.success) {
      setMessage(`Configured ${broker} successfully`);
      refreshBrokerStatus();
      return;
    }
    setMessage(res.error || `Unable to configure ${broker}`);
  };

  const connect = async (broker) => {
    const json = await getBrokerLoginUrl(broker);
    if (json.login_url) {
      window.location.href = json.login_url;
      return;
    }
    setMessage(json.error || `Unable to connect ${broker}`);
  };

  const disconnect = async (broker) => {
    const res = await disconnectBroker(broker);
    if (res.success) {
      setMessage(`Disconnected ${broker} successfully`);
      refreshBrokerStatus();
      return;
    }
    setMessage(res.error || `Unable to disconnect ${broker}`);
  };

  useEffect(() => {
    refreshBrokerStatus();
  }, []);

  const brokerMeta = {
    zerodha: {
      title: "Zerodha",
      fields: [
        { name: "api_key", label: "API Key" },
        { name: "api_secret", label: "API Secret", type: "password" },
      ],
    },
    fyers: {
      title: "Fyers",
      fields: [
        { name: "api_key", label: "API Key / Client ID" },
        { name: "api_secret", label: "API Secret", type: "password" },
        { name: "redirect_uri", label: "Redirect URI (optional)" },
        { name: "access_token", label: "Access Token (optional)" },
      ],
    },
    stoxkart: {
      title: "Stoxkart",
      fields: [
        { name: "api_key", label: "API Key / Client ID" },
        { name: "api_secret", label: "API Secret", type: "password" },
        { name: "redirect_uri", label: "Redirect URI (optional)" },
        { name: "auth_base_url", label: "Auth Base URL (optional)" },
        { name: "token_url", label: "Token URL (optional)" },
        { name: "api_base_url", label: "API Base URL (optional)" },
        { name: "access_token", label: "Access Token (optional)" },
      ],
    },
  };

  const activeMeta = brokerMeta[selectedBroker];
  const activeState = brokerStatus?.brokers?.[selectedBroker] || {};
  const brokerCreds = credentials[selectedBroker] || {};
  const hasConnectedBroker = Object.entries(brokerStatus?.brokers || {}).find(([, state]) => !!state?.connected);
  const connectedBrokerName = hasConnectedBroker?.[0] || null;
  const connectedBrokerLabel = connectedBrokerName
    ? connectedBrokerName.charAt(0).toUpperCase() + connectedBrokerName.slice(1)
    : null;

  if (connectedBrokerLabel) {
    return (
      <div className="space-y-6 max-w-3xl mx-auto">
        <div className="card neutral">
          <div className="rounded-md border border-green-500/70 bg-green-500/10 px-3 py-2 text-sm font-bold text-green-300">
            CONNECTED TO {connectedBrokerLabel.toUpperCase()}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6 max-w-3xl mx-auto">
      <div className="card neutral">
        <div className="section-title">Connect Broker</div>

        <div className="mt-2">
          <select
            className="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700 text-sm"
            value={selectedBroker}
            onChange={(e) => setSelectedBroker(e.target.value)}
          >
            {Object.entries(brokerMeta).map(([key, meta]) => (
              <option key={key} value={key}>{meta.title}</option>
            ))}
          </select>
        </div>

        <div className="mt-4 space-y-2 text-sm">
          <div>Configured: <span className="font-semibold">{activeState.configured ? "Yes" : "No"}</span></div>
          <div>Connected: <span className="font-semibold">{activeState.connected ? "Yes" : "No"}</span></div>
        </div>

        <div className="mt-4 space-y-2">
          {activeMeta.fields.map((field) => (
            <input
              key={field.name}
              type={field.type || "text"}
              placeholder={field.label}
              className="w-full px-3 py-2 rounded bg-gray-900 border border-gray-700 text-sm"
              value={brokerCreds[field.name] || ""}
              onChange={(e) => onFieldChange(selectedBroker, field.name, e.target.value)}
            />
          ))}
        </div>

        <div className="flex items-center justify-between mt-4 gap-2 flex-wrap">
          <div className="flex gap-2 flex-wrap">
            <button onClick={() => configureBroker(selectedBroker)} className="px-3 py-2 rounded-md text-white bg-emerald-600 hover:bg-emerald-500 text-sm">Save Keys</button>
            {!activeState.connected && (
              <button onClick={() => connect(selectedBroker)} className="px-3 py-2 rounded-md text-white bg-indigo-600 hover:bg-indigo-500 text-sm">Connect</button>
            )}
            <button
              onClick={() => disconnect(selectedBroker)}
              className="px-3 py-2 rounded-md text-white bg-rose-600 hover:bg-rose-500 text-sm disabled:bg-gray-600 disabled:cursor-not-allowed"
              disabled={!activeState.connected}
            >
              Disconnect
            </button>
          </div>
          <label className="flex items-center gap-2 text-sm">
            <input type="checkbox" checked={selectedBrokers.includes(selectedBroker)} onChange={() => toggleBroker(selectedBroker)} />
            Use for deploy
          </label>
        </div>

        <div className="mt-4 flex gap-3 justify-end">
          <button onClick={onSkip} className="px-3 py-2 rounded-md text-white bg-gray-700 hover:bg-gray-600 text-sm">Skip</button>
        </div>
      </div>
      {message && <div className="text-sm text-emerald-300">{message}</div>}
      <div className="text-sm text-gray-300">Selected platform(s) for order execution: {selectedBrokers.join(", ") || "None"}</div>
    </div>
  );
}

/* ---------------- MMI ---------------- */

function MMITab({data, brokerStatus}) {
  const { mmi, indices } = data;
  if (!mmi) return null;

  const marketStates = indices?.marketStates || [];
  const indexSnapshot = indices?.indexSnapshot || {};
  const connectedBrokerName = Object.entries(brokerStatus?.brokers || {})
    .find(([, state]) => !!state?.connected)?.[0] || brokerStatus?.active_broker || null;
  const connectedBrokerLabel = connectedBrokerName
    ? connectedBrokerName.charAt(0).toUpperCase() + connectedBrokerName.slice(1)
    : null;

  return (
    <div className="space-y-8">
      <LiveIndicesCard indices={indices} connectedBrokerLabel={connectedBrokerLabel} />

      <div className={getCardClass(mmi?.zone)}>
        <div className="section-title">Market Mood Index (Investment)</div>

        <KeyValue label="Value" value={mmi?.value}/>
        <KeyValue label="Zone" value={mmi?.zone}/>
        <div className="mt-3 text-sm break-words">{mmi?.action}</div>

        {mmi?.portfolio_guidance && (
          <div className="mt-4 border-t border-gray-700 pt-3 space-y-1">
            <KeyValue label="Regime" value={mmi?.portfolio_guidance?.regime}/>
            <KeyValue label="Investment View" value={mmi?.portfolio_guidance?.investment_view}/>
            <KeyValue label="Equity Exposure" value={mmi?.portfolio_guidance?.equity_exposure}/>
            <KeyValue label="Risk Level" value={mmi?.portfolio_guidance?.risk_level}/>
            <KeyValue label="Strategy" value={mmi?.portfolio_guidance?.action}/>
          </div>
        )}
      </div>

      <div className="grid md:grid-cols-2 gap-6">
        <div className="card neutral">
          <div className="section-title">NSE Market Sessions</div>
          {marketStates.length === 0 ? (
            <div className="text-sm text-gray-400">Session data unavailable.</div>
          ) : (
            <div className="space-y-2 text-sm">
              {marketStates.map((state, idx) => (
                <div key={`${state?.market || 'market'}-${idx}`} className="flex items-center justify-between border-b border-gray-800 pb-1 last:border-0">
                  <span className="text-gray-300">{state?.market || 'Unknown'}</span>
                  <span className={state?.isOpen ? "text-green-400 font-semibold" : "text-amber-400 font-semibold"}>{state?.status || 'Unknown'}</span>
                </div>
              ))}
            </div>
          )}
        </div>

        <div className="card neutral">
          <div className="section-title">NSE Broader Index Snapshot</div>
          <div className="space-y-2 text-sm">
            {Object.entries(indexSnapshot).length === 0 && (
              <div className="text-gray-400">Snapshot data unavailable.</div>
            )}
            {Object.entries(indexSnapshot).map(([name, values]) => (
              <div key={name} className="border-b border-gray-800 pb-2 last:border-0">
                <div className="font-semibold text-gray-200">{name}</div>
                <div className="grid grid-cols-2 gap-2 mt-1">
                  <KeyValue label="Last" value={formatIndexValue(values?.last)} />
                  <KeyValue label="Change %" value={formatPercent(values?.percentChange)} />
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
}

function FiiDiiTab() {
  return (
    <div className="bg-black border border-gray-800 rounded-xl min-h-[65vh] flex items-center justify-center">
      <div className="text-center px-6">
        <div className="text-xl font-semibold text-gray-200">FII DII Data</div>
        <div className="text-sm text-gray-500 mt-2">Data view coming soon.</div>
      </div>
    </div>
  );
}

/* ---------------- MAIN APP ---------------- */

function App() {
  const { data } = useAPI();
  const [tab, setTab] = useState("dashboard");
  const [selectedBrokers, setSelectedBrokers] = useState(["zerodha"]);
  const [brokerStatus, setBrokerStatus] = useState({});
  const [livePnl, setLivePnl] = useState({ success: true, total_pnl: 0, day_m2m: 0, open_positions: 0, source: "Not initialized" });
  const [hasTradeActivity, setHasTradeActivity] = useState(false);
  const failoverEnabled = false;
  const isBrokerSetupPage = window.location.pathname === "/broker-setup";

  const refreshBrokerStatus = async () => {
    try {
      const status = await getBrokerStatus();
      setBrokerStatus(status);
    } catch {}
  };

  const refreshLivePnl = async () => {
    if (!hasTradeActivity) {
      setLivePnl({ success: true, total_pnl: 0, day_m2m: 0, open_positions: 0, source: "No trades yet" });
      return;
    }
    try {
      const pnl = await getBrokerLivePnl();
      setLivePnl(pnl);
    } catch {}
  };

  const registerTradeActivity = () => {
    setHasTradeActivity(true);
  };

  const finishBrokerSetup = () => {
    window.location.href = "/";
  };

  useEffect(() => {
    refreshBrokerStatus();
  }, []);

  useEffect(() => {
    refreshLivePnl();
    const interval = setInterval(refreshLivePnl, 5000);
    return () => clearInterval(interval);
  }, [hasTradeActivity]);

  useEffect(() => {
    if (!isBrokerSetupPage) return;
    const hasConnectedBroker = Object.values(brokerStatus?.brokers || {}).some((status) => status?.connected);
    if (!hasConnectedBroker) {
      return;
    }

    const timeout = setTimeout(() => {
      finishBrokerSetup();
    }, 2000);

    return () => clearTimeout(timeout);
  }, [brokerStatus, isBrokerSetupPage]);

  return (
    <div className="p-6 max-w-7xl mx-auto">
      {isBrokerSetupPage ? (
        <BrokersTab
          selectedBrokers={selectedBrokers}
          setSelectedBrokers={setSelectedBrokers}
          brokerStatus={brokerStatus}
          refreshBrokerStatus={refreshBrokerStatus}
          onSkip={finishBrokerSetup}
        />
      ) : (
        <>
          <div className="flex items-center justify-between border-b border-gray-700 mb-6">
            <div className="flex">
              <div className={`tab ${tab==="dashboard"?"tab-active":""}`} onClick={()=>setTab("dashboard")}>Market Indicators</div>
              <div className={`tab ${tab==="options"?"tab-active":""}`} onClick={()=>setTab("options")}>Market Options Strategy</div>
              <div className={`tab ${tab==="mmi"?"tab-active":""}`} onClick={()=>setTab("mmi")}>MMI (Investment)</div>
              <div className={`tab ${tab==="fii-dii"?"tab-active":""}`} onClick={()=>setTab("fii-dii")}>FII DII Data</div>
            </div>
            <a href="/broker-setup" className="text-sm text-indigo-300 hover:text-indigo-200">Broker Setup</a>
          </div>

          {tab==="dashboard" && <DashboardTab data={data} brokerStatus={brokerStatus} livePnl={livePnl} />}
          {tab==="options" && <OptionsEngineTab data={data} selectedBrokers={selectedBrokers} brokerStatus={brokerStatus} failoverEnabled={failoverEnabled} livePnl={livePnl} onTradeActivity={registerTradeActivity} />}
          {tab==="mmi" && <MMITab data={data} brokerStatus={brokerStatus} />}
          {tab==="fii-dii" && <FiiDiiTab />}
        </>
      )}

    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>

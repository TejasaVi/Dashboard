<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Advanced Market Dashboard</title>

<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#0f172a; color:#e2e8f0; }
.card { border-radius:14px; padding:20px; border:1px solid #1f2937; transition:0.3s; }
.section-title { font-size:18px; font-weight:600; margin-bottom:10px; }
.tab { cursor:pointer; padding:12px 20px; }
.tab-active { border-bottom:2px solid #6366f1; }

.bullish { background:rgba(16,185,129,0.08); border-color:#10b981; }
.bearish { background:rgba(244,63,94,0.08); border-color:#f43f5e; }
.neutral { background:rgba(99,102,241,0.08); border-color:#6366f1; }
.warning { background:rgba(245,158,11,0.08); border-color:#f59e0b; }
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;

const endpoints = {
  pcr: "/api/pcr",
  vix: "/api/vix",
  indices: "/api/indices",
  oi: "/api/oi-change",
  mmi: "/api/mmi",
  rsi: "/api/rsi",
  bias: "/api/marketbias"
};

function getCardClass(text) {
  if (!text) return "card neutral";
  const t = text.toLowerCase();
  if (t.includes("bull")) return "card bullish";
  if (t.includes("bear")) return "card bearish";
  if (t.includes("greed")) return "card warning";
  if (t.includes("fear")) return "card bearish";
  if (t.includes("complacent")) return "card bullish";
  if (t.includes("stable")) return "card bullish";
  if (t.includes("nervous")) return "card bearish";
  
  return "card neutral";
}

function useAPI() {
  const [data, setData] = useState({});
  const [lastUpdate, setLastUpdate] = useState("");

  function isMarketOpen() {
    const now = new Date();

    // Convert to IST explicitly
    const istTime = new Date(
      now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
    );

    const hours = istTime.getHours();
    const minutes = istTime.getMinutes();

    const totalMinutes = hours * 60 + minutes;

    const marketOpen = 9 * 60;        // 9:00 AM
    const marketClose = 15 * 60 + 30; // 3:30 PM

    return totalMinutes >= marketOpen && totalMinutes <= marketClose;
  }

  async function fetchAll() {
    const results = {};
    for (const key in endpoints) {
      try {
        const res = await fetch(endpoints[key]);
        results[key] = await res.json();
      } catch {
        results[key] = null;
      }
    }
    setData(results);
    setLastUpdate(new Date().toLocaleTimeString());
  }

  useEffect(() => {
    fetchAll();

    if (!isMarketOpen()) {
      // ðŸš« Market closed â†’ fetch once only
      return;
    }

    // âœ… Market open â†’ keep refreshing
    const interval = setInterval(fetchAll, 3000);
    return () => clearInterval(interval);

  }, []);

  return { data, lastUpdate };
}


function KeyValue({label, value}) {
  return (
    <div className="flex justify-between py-1 text-sm gap-3 items-start">
      <span className="text-gray-400 flex-shrink-0 min-w-0">{label}</span>
      <span className="text-right break-words overflow-wrap-anywhere max-w-[60%]">{value ?? "-"}</span>
    </div>
  );
}

function LiveIndicesCard({indices}) {
  return (
    <div className="card neutral">
      <div className="section-title">Live Indices</div>
      <div className="grid grid-cols-3 gap-6 text-center">
        <div>
          <div className="text-3xl font-bold text-cyan-400">{indices?.NIFTY50}</div>
          <div className="text-gray-400">NIFTY50</div>
        </div>
        <div>
          <div className="text-3xl font-bold text-emerald-400">{indices?.BANKNIFTY}</div>
          <div className="text-gray-400">BANKNIFTY</div>
        </div>
        <div>
          <div className="text-3xl font-bold text-rose-400">{indices?.SENSEX}</div>
          <div className="text-gray-400">SENSEX</div>
        </div>
      </div>
      <div className="mt-4 text-gray-500 text-sm">{indices?.timestamp}</div>
    </div>
  );
}

/* ---------------- DASHBOARD ---------------- */

function DashboardTab({data, lastUpdate}) {
  const { pcr, vix, oi, rsi, indices } = data;

  return (
    <div className="space-y-8">
      <LiveIndicesCard indices={indices} />

      <div className="grid md:grid-cols-3 gap-6">

        <div className={getCardClass(pcr?.zone)}>
          <div className="section-title">Overall PCR</div>
          <KeyValue label="PCR" value={pcr?.pcr}/>
          <KeyValue label="Sentiment" value={pcr?.sentiment}/>
          <KeyValue label="Zone" value={pcr?.zone}/>
          <div className="mt-3 text-sm break-words">{pcr?.action}</div>
        </div>

        <div className={getCardClass(vix?.sentiment)}>
          <div className="section-title">VIX</div>
          <KeyValue label="VIX" value={vix?.vix}/>
          <KeyValue label="Sentiment" value={vix?.sentiment}/>
          <div className="mt-3 text-sm break-words">{vix?.action}</div>
        </div>

        <div className={getCardClass(oi?.zone)}>
          <div className="section-title">Intraday OI Change PCR</div>
          <KeyValue label="Value" value={oi?.oi_change_pcr}/>
          <KeyValue label="Sentiment" value={oi?.sentiment}/>
          <KeyValue label="Zone" value={oi?.zone}/>
          <div className="mt-3 text-sm break-words">{oi?.action}</div>
        </div>

        <div className={getCardClass(rsi?.sentiment)}>
          <div className="section-title">RSI</div>
          <KeyValue label="RSI 15min" value={rsi?.rsi15min}/>
          <KeyValue label="RSI 1hr" value={rsi?.rsi1hr}/>
          <KeyValue label="Sentiment" value={rsi?.sentiment}/>
        </div>

      </div>
    </div>
  );
}

/* ---------------- OPTIONS STRATEGY ENGINE ---------------- */

function StrategyAccordion({ name, data }) {
  const [open, setOpen] = useState(false);
  if (!data) return null;

  return (
    <div className="border border-gray-700 rounded-lg mt-3 overflow-hidden">
      <div onClick={() => setOpen(!open)}
        className="cursor-pointer bg-gray-800 px-4 py-3 flex justify-between items-center hover:bg-gray-700">
        <span className="font-medium">{name}</span>
        <span>{open ? "â–²" : "â–¼"}</span>
      </div>

      {open && (
        <div className="bg-gray-900 px-4 py-3">
          {Object.entries(data).map(([k,v]) => (
            <KeyValue key={k} label={k} value={v}/>
          ))}
        </div>
      )}
    </div>
  );
}

function OptionsEngineTab({data}) {
  const { bias, indices } = data;
  if (!bias) return null;

  return (
    <div className="space-y-8">
      <LiveIndicesCard indices={indices} />

      <div className={getCardClass(bias?.bias)}>
        <div className="section-title">Options Strategy Engine</div>
        <KeyValue label="Bias" value={bias?.bias}/>
        <KeyValue label="Score" value={bias?.score}/>
        <KeyValue label="VIX" value={bias?.vix}/>
        <div className="mt-4 border-t border-gray-700 pt-3">
		<div className="text-sm font-medium break-words">
			Execution Guidance: {bias?.primary_action || "Awaiting Setup"}
		</div>
</div>

      </div>

      <div className="card neutral">
        <div className="section-title">Strategy List</div>

        <StrategyAccordion name="Butterfly" data={bias?.strikes?.butterfly}/>
        <StrategyAccordion name="Iron Condor" data={bias?.strikes?.iron_condor}/>
        <StrategyAccordion name="Calendar" data={bias?.strikes?.calendar}/>
        <StrategyAccordion name="Call Spread" data={bias?.strikes?.spread_ce}/>
        <StrategyAccordion name="Put Spread" data={bias?.strikes?.spread_pe}/>
      </div>
    </div>
  );
}

/* ---------------- MMI INVESTMENT ---------------- */

function MMITab({data}) {
  const { mmi, indices } = data;
  if (!mmi) return null;

  return (
    <div className="space-y-8">
      <LiveIndicesCard indices={indices} />

      <div className={getCardClass(mmi?.zone)}>
        <div className="section-title">Market Mood Index (Investment)</div>

        <KeyValue label="Value" value={mmi?.value}/>
        <KeyValue label="Zone" value={mmi?.zone}/>
        <div className="mt-3 text-sm break-words">{mmi?.action}</div>

        {mmi?.portfolio_guidance && (
          <div className="mt-4 border-t border-gray-700 pt-3 space-y-1">
            <KeyValue label="Regime" value={mmi?.portfolio_guidance?.regime}/>
            <KeyValue label="Investment View" value={mmi?.portfolio_guidance?.investment_view}/>
            <KeyValue label="Equity Exposure" value={mmi?.portfolio_guidance?.equity_exposure}/>
            <KeyValue label="Risk Level" value={mmi?.portfolio_guidance?.risk_level}/>
            <KeyValue label="Strategy" value={mmi?.portfolio_guidance?.action}/>
          </div>
        )}
      </div>
    </div>
  );
}

/* ---------------- MAIN APP ---------------- */

function App() {
  const { data } = useAPI();
  const [tab, setTab] = useState("dashboard");

  return (
    <div className="p-6 max-w-7xl mx-auto">

      <div className="flex border-b border-gray-700 mb-6">
        <div className={`tab ${tab==="dashboard"?"tab-active":""}`}
          onClick={()=>setTab("dashboard")}>
          Dashboard
        </div>

        <div className={`tab ${tab==="options"?"tab-active":""}`}
          onClick={()=>setTab("options")}>
          Options Strategy Engine
        </div>

        <div className={`tab ${tab==="mmi"?"tab-active":""}`}
          onClick={()=>setTab("mmi")}>
          MMI (Investment)
        </div>
      </div>

      {tab==="dashboard" && <DashboardTab data={data} />}
      {tab==="options" && <OptionsEngineTab data={data} />}
      {tab==="mmi" && <MMITab data={data} />}

    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>

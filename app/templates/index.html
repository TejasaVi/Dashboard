<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Advanced Market Dashboard</title>

<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body { background:#0f172a; color:#e2e8f0; }
.card { border-radius:14px; padding:20px; border:1px solid #1f2937; transition:0.3s; }
.section-title { font-size:18px; font-weight:600; margin-bottom:10px; }
.tab { cursor:pointer; padding:12px 20px; }
.tab-active { border-bottom:2px solid #6366f1; }

.bullish { background:rgba(16,185,129,0.08); border-color:#10b981; }
.bearish { background:rgba(244,63,94,0.08); border-color:#f43f5e; }
.neutral { background:rgba(99,102,241,0.08); border-color:#6366f1; }
.warning { background:rgba(245,158,11,0.08); border-color:#f59e0b; }

.glow-green {
  animation: glow 1.5s ease forwards;
}

@keyframes glow {
  0% { background-color: #10b981; box-shadow: 0 0 5px #10b981; }
  50% { background-color: #22c55e; box-shadow: 0 0 15px #22c55e; }
  100% { background-color: #6366f1; box-shadow: none; }
}
</style>
</head>

<body>
<div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;

const endpoints = {
  pcr: "/api/pcr",
  vix: "/api/vix",
  indices: "/api/indices",
  oi: "/api/oi-change",
  mmi: "/api/mmi",
  rsi: "/api/rsi",
  bias: "/api/marketbias",
  niftyavgs: "/api/niftyavgs"
};

function getCardClass(text) {
  if (!text) return "card neutral";
  const t = text.toLowerCase();
  if (t.includes("bull")) return "card bullish";
  if (t.includes("bear")) return "card bearish";
  if (t.includes("greed")) return "card warning";
  if (t.includes("fear")) return "card bearish";
  if (t.includes("complacent")) return "card bullish";
  if (t.includes("stable")) return "card bullish";
  if (t.includes("nervous")) return "card bearish";
  
  return "card neutral";
}

function useAPI() {
  const [data, setData] = useState({});

  function isMarketOpen() {
    const now = new Date();
    const istTime = new Date(
      now.toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
    );
    const hours = istTime.getHours();
    const minutes = istTime.getMinutes();
    const totalMinutes = hours * 60 + minutes;
    const marketOpen = 9 * 60;
    const marketClose = 15 * 60 + 30;
    return totalMinutes >= marketOpen && totalMinutes <= marketClose;
  }

  async function fetchAll() {
    const results = {};
    for (const key in endpoints) {
      try {
        const res = await fetch(endpoints[key]);
        results[key] = await res.json();
      } catch {
        results[key] = null;
      }
    }
    setData(results);
  }

  useEffect(() => {
    fetchAll();
    if (!isMarketOpen()) return;
    const interval = setInterval(fetchAll, 3000);
    return () => clearInterval(interval);
  }, []);

  return { data };
}

function KeyValue({label, value}) {
  return (
    <div className="flex justify-between py-1 text-sm gap-3 items-start">
      <span className="text-gray-400 flex-shrink-0 min-w-0">{label}</span>
      <span className="text-right break-words overflow-wrap-anywhere max-w-[60%]">{value ?? "-"}</span>
    </div>
  );
}

function LiveIndicesCard({indices}) {
  return (
    <div className="card neutral">
      <div className="section-title">Live Indices</div>
      <div className="grid grid-cols-3 gap-6 text-center">
        <div>
          <div className="text-3xl font-bold text-cyan-400">{indices?.NIFTY50}</div>
          <div className="text-gray-400">NIFTY50</div>
        </div>
        <div>
          <div className="text-3xl font-bold text-emerald-400">{indices?.BANKNIFTY}</div>
          <div className="text-gray-400">BANKNIFTY</div>
        </div>
        <div>
          <div className="text-3xl font-bold text-rose-400">{indices?.SENSEX}</div>
          <div className="text-gray-400">SENSEX</div>
        </div>
      </div>
      <div className="mt-4 text-gray-500 text-sm">{indices?.timestamp}</div>
    </div>
  );
}

/* ---------------- MOVING AVERAGES CARDS ---------------- */

function NiftyPriceCard({niftyavgs}) {
  if (!niftyavgs) return null;

  const { price_data, trend_analysis } = niftyavgs;

  // Determine overall trend from trend_analysis
  const hasBullishTrend = trend_analysis?.some(t => t.includes("bullish"));
  const hasBearishTrend = trend_analysis?.some(t => t.includes("Bearish"));
  
  let trendClass = "card neutral";
  if (hasBullishTrend && !hasBearishTrend) trendClass = "card bullish";
  else if (hasBearishTrend) trendClass = "card bearish";

  return (
    <div className={trendClass}>
      <div className="section-title">NIFTY Trend Analysis</div>
      
      {/* Current Price */}
      {price_data && (
        <div className="mb-3 pb-3 border-b border-gray-700">
          <div className="flex justify-between items-center">
            <span className="text-gray-400">Current Price</span>
            <span className="text-2xl font-bold text-white">{price_data.close}</span>
          </div>
          <div className="grid grid-cols-3 gap-2 mt-3 text-sm">
            <div>
              <div className="text-gray-400">High</div>
              <div className="text-green-400 font-semibold">{price_data.high}</div>
            </div>
            <div>
              <div className="text-gray-400">Low</div>
              <div className="text-red-400 font-semibold">{price_data.low}</div>
            </div>
            <div>
              <div className="text-gray-400">Volume</div>
              <div className="text-blue-400 font-semibold">{price_data.volume}</div>
            </div>
          </div>
        </div>
      )}

      {/* Trend Analysis */}
      {trend_analysis && trend_analysis.length > 0 && (
        <div>
          <div className="text-sm font-semibold text-gray-300 mb-2">Trend Signals</div>
          {trend_analysis.map((trend, idx) => (
            <div key={idx} className="text-sm text-gray-300 py-1">
              • {trend}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

function SimpleMovingAveragesCard({niftyavgs}) {
  if (!niftyavgs) return null;

  const { moving_averages } = niftyavgs;

  return (
    <div className="card neutral">
      <div className="section-title">Simple Moving Averages</div>
      {moving_averages && (
        <div className="space-y-1">
          <KeyValue 
            label="MA 10" 
            value={`${moving_averages.MA_10?.value} (${moving_averages.MA_10?.position} ${moving_averages.MA_10?.difference_percent}%)`}
          />
          <KeyValue 
            label="MA 20" 
            value={`${moving_averages.MA_20?.value} (${moving_averages.MA_20?.position} ${moving_averages.MA_20?.difference_percent}%)`}
          />
          <KeyValue 
            label="MA 50" 
            value={`${moving_averages.MA_50?.value} (${moving_averages.MA_50?.position} ${moving_averages.MA_50?.difference_percent}%)`}
          />
          <KeyValue 
            label="MA 100" 
            value={`${moving_averages.MA_100?.value} (${moving_averages.MA_100?.position} ${moving_averages.MA_100?.difference_percent}%)`}
          />
        </div>
      )}
    </div>
  );
}

function ExponentialMovingAveragesCard({niftyavgs}) {
  if (!niftyavgs) return null;

  const { exponential_moving_averages } = niftyavgs;

  return (
    <div className="card neutral">
      <div className="section-title">Exponential Moving Averages</div>
      {exponential_moving_averages && (
        <div className="space-y-1">
          <KeyValue 
            label="EMA 10" 
            value={`${exponential_moving_averages.EMA_10?.value} (${exponential_moving_averages.EMA_10?.position} ${exponential_moving_averages.EMA_10?.difference_percent}%)`}
          />
          <KeyValue 
            label="EMA 20" 
            value={`${exponential_moving_averages.EMA_20?.value} (${exponential_moving_averages.EMA_20?.position} ${exponential_moving_averages.EMA_20?.difference_percent}%)`}
          />
          <KeyValue 
            label="EMA 50" 
            value={`${exponential_moving_averages.EMA_50?.value} (${exponential_moving_averages.EMA_50?.position} ${exponential_moving_averages.EMA_50?.difference_percent}%)`}
          />
          <KeyValue 
            label="EMA 100" 
            value={`${exponential_moving_averages.EMA_100?.value} (${exponential_moving_averages.EMA_100?.position} ${exponential_moving_averages.EMA_100?.difference_percent}%)`}
          />
        </div>
      )}
    </div>
  );
}

/* ---------------- DASHBOARD ---------------- */

function DashboardTab({data}) {
  const { pcr, vix, oi, rsi, indices, niftyavgs } = data;

  return (
    <div className="space-y-8">
      <LiveIndicesCard indices={indices} />

      <div className="grid md:grid-cols-3 gap-6">

        <div className={getCardClass(pcr?.zone)}>
          <div className="section-title">Overall PCR</div>
          <KeyValue label="PCR" value={pcr?.pcr}/>
          <KeyValue label="Sentiment" value={pcr?.sentiment}/>
          <KeyValue label="Zone" value={pcr?.zone}/>
          <div className="mt-3 text-sm break-words">{pcr?.action}</div>
        </div>

        <div className={getCardClass(vix?.sentiment)}>
          <div className="section-title">VIX</div>
          <KeyValue label="VIX" value={vix?.vix}/>
          <KeyValue label="Sentiment" value={vix?.sentiment}/>
          <div className="mt-3 text-sm break-words">{vix?.action}</div>
        </div>

        <div className={getCardClass(oi?.zone)}>
          <div className="section-title">Intraday OI Change PCR</div>
          <KeyValue label="Value" value={oi?.oi_change_pcr}/>
          <KeyValue label="Sentiment" value={oi?.sentiment}/>
          <KeyValue label="Zone" value={oi?.zone}/>
          <div className="mt-3 text-sm break-words">{oi?.action}</div>
        </div>

        <div className={getCardClass(rsi?.sentiment)}>
          <div className="section-title">RSI</div>
          <KeyValue label="RSI 15min" value={rsi?.rsi15min}/>
          <KeyValue label="RSI 1hr" value={rsi?.rsi1hr}/>
          <KeyValue label="Sentiment" value={rsi?.sentiment}/>
        </div>

        {/* NIFTY Price and Trend Card */}
        <NiftyPriceCard niftyavgs={niftyavgs} />

        {/* Simple Moving Averages Card */}
        <SimpleMovingAveragesCard niftyavgs={niftyavgs} />

        {/* Exponential Moving Averages Card */}
        <ExponentialMovingAveragesCard niftyavgs={niftyavgs} />

      </div>
    </div>
  );
}

/* ---------------- STRATEGY ACCORDION ---------------- */

function StrategyAccordion({ name, data, isOpen, onToggle }) {
  const [deployed, setDeployed] = useState(false);
  const [quantity, setQuantity] = useState(1);

  if (!data) return null;

  const handleDeploy = (e) => {
    e.stopPropagation();
    console.log(`Executed strategy: ${name} with quantity: ${quantity}`);
    setDeployed(true);
    setTimeout(() => setDeployed(false), 1500);
  };

  return (
    <div className="border border-gray-700 rounded-lg mt-3 overflow-hidden">
      <div
        onClick={() => onToggle(name)}
        className="cursor-pointer bg-gray-800 px-4 py-3 flex justify-between items-center hover:bg-gray-700"
      >
        <span className="font-medium">{name}</span>
        <span>{isOpen ? "▲" : "▼"}</span>
      </div>

      {isOpen && (
        <div className="bg-gray-900 px-4 py-3 space-y-2">
          {Object.entries(data).map(([k,v]) => (
            <KeyValue key={k} label={k} value={v}/>
          ))}

          <div className="flex items-center gap-4 mt-2">
            <select
              className="px-2 py-1 rounded bg-gray-800 border border-gray-600 text-white"
              value={quantity}
              onChange={(e) => setQuantity(Number(e.target.value))}
            >
              {[...Array(10)].map((_, i) => (
                <option key={i+1} value={i+1}>{i+1}</option>
              ))}
            </select>

            <button
              onClick={handleDeploy}
              className={`px-4 py-2 rounded-md text-white ${deployed ? "bg-green-500 glow-green" : "bg-indigo-600 hover:bg-indigo-500"}`}
            >
              Deploy
            </button>
            {deployed && <span className="text-green-400 font-medium">Successfully deployed</span>}
          </div>
        </div>
      )}
    </div>
  );
}

/* ---------------- ATM OPTIONS CARD ---------------- */

function ATMOptionsCard({ ce, pe }) {
  const [ceQty, setCeQty] = useState(1);
  const [peQty, setPeQty] = useState(1);
  const [ceDeployed, setCeDeployed] = useState(false);
  const [peDeployed, setPeDeployed] = useState(false);

  const handleCeDeploy = () => {
    console.log("Deployed CE strike", { ce, ceQty });
    setCeDeployed(true);
    setTimeout(() => setCeDeployed(false), 1500);
  };

  const handlePeDeploy = () => {
    console.log("Deployed PE strike", { pe, peQty });
    setPeDeployed(true);
    setTimeout(() => setPeDeployed(false), 1500);
  };

  return (
    <div className="card neutral mt-4 p-4">
      <div className="section-title">ATM Options</div>

      <div className="grid grid-cols-1 gap-6 mt-2">

        {/* CE Strike */}
        <div className="flex flex-col gap-2">
          <div className="flex items-center justify-between">
            <div className="flex flex-col">
              <div className="font-medium">CE Strike</div>
              <div className="text-sm text-gray-200">{ce ?? "-"}</div>
            </div>
            <div className="flex gap-2">
              <select
                className="px-2 py-1 rounded bg-gray-800 border border-gray-600 text-white"
                value={ceQty}
                onChange={(e) => setCeQty(Number(e.target.value))}
              >
                {[...Array(100)].map((_, i) => (
                  <option key={i+1} value={i+1}>{i+1}</option>
                ))}
              </select>
              <button
                onClick={handleCeDeploy}
                className={`px-4 py-2 rounded-md text-white ${ceDeployed ? "bg-green-500 glow-green" : "bg-indigo-600 hover:bg-indigo-500"}`}
              >
                Deploy CE
              </button>
              {ceDeployed && <span className="text-green-400 font-medium">Deployed</span>}
            </div>
          </div>
        </div>

        {/* Separator Line */}
        <div className="border-t border-gray-600 mx-4"></div>

        {/* PE Strike */}
        <div className="flex flex-col gap-2">
          <div className="flex items-center justify-between">
            <div className="flex flex-col">
              <div className="font-medium">PE Strike</div>
              <div className="text-sm text-gray-200">{pe ?? "-"}</div>
            </div>
            <div className="flex gap-2">
              <select
                className="px-2 py-1 rounded bg-gray-800 border border-gray-600 text-white"
                value={peQty}
                onChange={(e) => setPeQty(Number(e.target.value))}
              >
                {[...Array(100)].map((_, i) => (
                  <option key={i+1} value={i+1}>{i+1}</option>
                ))}
              </select>
              <button
                onClick={handlePeDeploy}
                className={`px-4 py-2 rounded-md text-white ${peDeployed ? "bg-green-500 glow-green" : "bg-indigo-600 hover:bg-indigo-500"}`}
              >
                Deploy PE
              </button>
              {peDeployed && <span className="text-green-400 font-medium">Deployed</span>}
            </div>
          </div>
        </div>

      </div>
    </div>
  );
}

/* ---------------- OPTIONS ENGINE TAB ---------------- */

function OptionsEngineTab({data}) {
  const { bias, indices } = data;
  const [openStrategy, setOpenStrategy] = useState(null);

  if (!bias) return null;

  const handleToggle = (name) => setOpenStrategy(openStrategy === name ? null : name);

  return (
    <div className="space-y-8">
      <LiveIndicesCard indices={indices} />

      <div className={getCardClass(bias?.bias)}>
        <div className="section-title">Options Strategy Engine</div>
        <KeyValue label="Bias" value={bias?.bias}/>
        <KeyValue label="Score" value={bias?.score}/>
        <KeyValue label="VIX" value={bias?.vix}/>
        <div className="mt-4 border-t border-gray-700 pt-3">
          <div className="text-sm font-medium break-words">
            Execution Guidance: {bias?.primary_action || "Awaiting Setup"}
          </div>
        </div>
      </div>

      {/* ATM Options Card - MOVED ABOVE Strategy List */}
      <ATMOptionsCard ce={bias?.strikes?.ce_strike} pe={bias?.strikes?.pe_strike} />

      <div className="card neutral">
        <div className="section-title">Strategy List</div>

        <StrategyAccordion
          name="Butterfly"
          data={bias?.strikes?.butterfly}
          isOpen={openStrategy === "Butterfly"}
          onToggle={handleToggle}
        />
        <StrategyAccordion
          name="Iron Condor"
          data={bias?.strikes?.iron_condor}
          isOpen={openStrategy === "Iron Condor"}
          onToggle={handleToggle}
        />
        <StrategyAccordion
          name="Calendar"
          data={bias?.strikes?.calendar}
          isOpen={openStrategy === "Calendar"}
          onToggle={handleToggle}
        />
        <StrategyAccordion
          name="Call Spread"
          data={bias?.strikes?.spread_ce}
          isOpen={openStrategy === "Call Spread"}
          onToggle={handleToggle}
        />
        <StrategyAccordion
          name="Put Spread"
          data={bias?.strikes?.spread_pe}
          isOpen={openStrategy === "Put Spread"}
          onToggle={handleToggle}
        />
      </div>
    </div>
  );
}

/* ---------------- MMI ---------------- */

function MMITab({data}) {
  const { mmi, indices } = data;
  if (!mmi) return null;

  return (
    <div className="space-y-8">
      <LiveIndicesCard indices={indices} />

      <div className={getCardClass(mmi?.zone)}>
        <div className="section-title">Market Mood Index (Investment)</div>

        <KeyValue label="Value" value={mmi?.value}/>
        <KeyValue label="Zone" value={mmi?.zone}/>
        <div className="mt-3 text-sm break-words">{mmi?.action}</div>

        {mmi?.portfolio_guidance && (
          <div className="mt-4 border-t border-gray-700 pt-3 space-y-1">
            <KeyValue label="Regime" value={mmi?.portfolio_guidance?.regime}/>
            <KeyValue label="Investment View" value={mmi?.portfolio_guidance?.investment_view}/>
            <KeyValue label="Equity Exposure" value={mmi?.portfolio_guidance?.equity_exposure}/>
            <KeyValue label="Risk Level" value={mmi?.portfolio_guidance?.risk_level}/>
            <KeyValue label="Strategy" value={mmi?.portfolio_guidance?.action}/>
          </div>
        )}
      </div>
    </div>
  );
}

/* ---------------- MAIN APP ---------------- */

function App() {
  const { data } = useAPI();
  const [tab, setTab] = useState("dashboard");

  return (
    <div className="p-6 max-w-7xl mx-auto">

      <div className="flex border-b border-gray-700 mb-6">
        <div className={`tab ${tab==="dashboard"?"tab-active":""}`} onClick={()=>setTab("dashboard")}>Market Indicators</div>
        <div className={`tab ${tab==="options"?"tab-active":""}`} onClick={()=>setTab("options")}>Market Options Strategy</div>
        <div className={`tab ${tab==="mmi"?"tab-active":""}`} onClick={()=>setTab("mmi")}>MMI (Investment)</div>
      </div>

      {tab==="dashboard" && <DashboardTab data={data} />}
      {tab==="options" && <OptionsEngineTab data={data} />}
      {tab==="mmi" && <MMITab data={data} />}

    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>
